import { ChangeDetectorRef, Component, ElementRef, EventEmitter, HostListener, Input, NgZone, Output, ViewChild, } from "@angular/core";
import { ToastType } from "../toast-type";
import { Toast } from "../toast";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export class ToastifyToastComponent {
    constructor(_cd, _zone) {
        this._cd = _cd;
        this._zone = _zone;
        this.autoClose = 5000;
        this.hideProgressBar = false;
        this.pauseOnHover = true;
        this.pauseOnVisibilityChange = true;
        this.closeOnClick = true;
        this.dismissEvent = new EventEmitter();
        this.ToastType = ToastType;
        this.running = false;
    }
    ngOnInit() {
        this.autoCloseRemaining = this.autoClose;
        this.startTime = this.toast.time;
        this.toast.$resetToast.subscribe(() => this.resetToastTimer());
        // Do not start timer when toast is prompted while window is out of focus
        if (this.handleVisibilityChange && document.visibilityState === "visible") {
            this.startCloseTimer();
        }
        // Start progress bar animation
        this.triggerProgressBarAnimation();
    }
    triggerProgressBarAnimation() {
        // Cancel previous animlation to avoid leaks
        if (this._progressBarAnimation !== undefined) {
            cancelAnimationFrame(this._progressBarAnimation);
        }
        // Start animation
        const frame = () => {
            if (this.running) {
                const remainingTime = Math.max(0, this.expectedAutoDismissTime - new Date().getTime());
                const percentage = 100 - ((remainingTime / this.autoClose) * 100);
                this.progressBarCover.nativeElement.style.width = percentage + "%";
                if (percentage <= 0)
                    return;
            }
            this._progressBarAnimation = requestAnimationFrame(frame);
        };
        this._progressBarAnimation = requestAnimationFrame(frame);
    }
    ngOnDestroy() {
        var _a, _b;
        // Cancel animation
        if (this._progressBarAnimation) {
            cancelAnimationFrame(this._progressBarAnimation);
            this._progressBarAnimation = undefined;
        }
        // Clear auto close timeout
        this.clearTimerTimeout();
        // Complete all observables
        (_a = this.toast.$resetToast) === null || _a === void 0 ? void 0 : _a.complete();
        this.toast.$resetToast = null;
        (_b = this._$updateTimer) === null || _b === void 0 ? void 0 : _b.complete();
        this._$updateTimer = null;
    }
    startCloseTimer() {
        if (this.running || !this.autoClose) {
            return;
        }
        this.running = true;
        this.expectedAutoDismissTime =
            new Date().getTime() + this.autoCloseRemaining;
        this.autoDismissTimeout = this._zone.runOutsideAngular(() => setTimeout(() => {
            this._zone.run(() => {
                this.dismissEvent.emit();
                this._cd.markForCheck();
            });
        }, this.autoCloseRemaining));
    }
    pauseCloseTimer() {
        this.running = false;
        this.clearTimerTimeout();
        // Calculate the elapsed time, subtract remaining time
        this.pauseTime = new Date().getTime();
        const elapsed = this.pauseTime - this.startTime;
        this.autoCloseRemaining = this.autoClose - elapsed;
    }
    resetToastTimer() {
        this.clearTimerTimeout();
        this.running = false;
        this.startTime = new Date().getTime();
        this.autoCloseRemaining = this.autoClose;
        this.startCloseTimer();
    }
    clearTimerTimeout() {
        if (this.autoDismissTimeout !== undefined) {
            this.expectedAutoDismissTime = undefined;
            clearTimeout(this.autoDismissTimeout);
        }
    }
    handleDismissButtonAction() {
        if (this.closeOnClick) {
            return; // Let the other event handle the dismissal
        }
        this.clearTimerTimeout();
        this.dismissEvent.emit();
    }
    handleHostClick() {
        if (this.closeOnClick) {
            this.clearTimerTimeout();
            this.dismissEvent.emit();
        }
    }
    handleMouseEnter() {
        if (this.pauseOnHover) {
            this.pauseCloseTimer();
        }
    }
    handleMouseLeave() {
        if (this.pauseOnHover) {
            this.startCloseTimer();
            this.startTime = new Date().getTime() + (this.startTime - this.pauseTime);
        }
    }
    handleVisibilityChange() {
        if (!this.pauseOnVisibilityChange) {
            return;
        }
        if (document.visibilityState !== "visible") {
            this.pauseCloseTimer();
            this._cd.detectChanges();
        }
        else {
            this.startCloseTimer();
        }
    }
}
/** @nocollapse */ ToastifyToastComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ToastifyToastComponent, deps: [{ token: i0.ChangeDetectorRef }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Component });
/** @nocollapse */ ToastifyToastComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.0.5", type: ToastifyToastComponent, selector: "lib-toastify-toast", inputs: { autoClose: "autoClose", hideProgressBar: "hideProgressBar", pauseOnHover: "pauseOnHover", pauseOnVisibilityChange: "pauseOnVisibilityChange", closeOnClick: "closeOnClick", toast: "toast", iconLibrary: "iconLibrary" }, outputs: { dismissEvent: "dismissEvent" }, host: { listeners: { "click": "handleHostClick()", "mouseenter": "handleMouseEnter()", "mouseleave": "handleMouseLeave()", "document:visibilitychange": "handleVisibilityChange()" } }, viewQueries: [{ propertyName: "progressBar", first: true, predicate: ["progressBar"], descendants: true }, { propertyName: "progressBarCover", first: true, predicate: ["progressBarCover"], descendants: true }], ngImport: i0, template: "<div role=\"alert\" class=\"toast-body\">\n    <div class=\"icon-container\">\n        <span *ngIf=\"iconLibrary == 'material'\" [ngSwitch]=\"toast.type\">\n            <i class=\"material-icons\" *ngSwitchCase=\"ToastType.info\">info_outline</i>\n            <i class=\"material-icons\" *ngSwitchCase=\"ToastType.default\">info_outline</i>\n            <i class=\"material-icons\" *ngSwitchCase=\"ToastType.warning\">warning_outline</i>\n            <i class=\"material-icons\" *ngSwitchCase=\"ToastType.error\">error_outline</i>\n            <i class=\"material-icons\" *ngSwitchCase=\"ToastType.success\">done</i>\n        </span>\n        <span *ngIf=\"iconLibrary == 'font-awesome'\" [ngSwitch]=\"toast.type\">\n            <i *ngSwitchCase=\"ToastType.info\" class=\"fa fa-info\"></i>\n            <i *ngSwitchCase=\"ToastType.default\" class=\"fa fa-info\"></i>\n            <i *ngSwitchCase=\"ToastType.warning\" class=\"fa fa-exclamation-triangle\"></i>\n            <i *ngSwitchCase=\"ToastType.error\" class=\"fa fa-exclamation\"></i>\n            <i *ngSwitchCase=\"ToastType.success\" class=\"fa fa-check\"></i>\n        </span>\n    </div>\n    <div class=\"toast-container\">\n        <span>{{toast.message}}</span>\n    </div>\n</div>\n<button (click)=\"handleDismissButtonAction()\" class=\"close-button close-button--{{ToastType[toast.type]}}\" type=\"button\" aria-label=\"close\">\u2716</button>\n\n<div #progressBar *ngIf=\"!hideProgressBar\" class=\"progress-bar progress-bar&#45;&#45;{{ToastType[toast.type]}}\" style=\"opacity: 1;\"></div>\n<div #progressBarCover *ngIf=\"!hideProgressBar\" class=\"progress-bar-cover toast--{{ToastType[toast.type]}}\" [style.animation-duration]=\"this.autoClose + 'ms'\"  [style.animation-play-state]=\"running? 'running' : 'paused'\"></div>\n", styles: [".toast{position:relative;min-height:64px;box-sizing:border-box;margin-bottom:1rem;padding:8px;border-radius:1px;box-shadow:0 1px 10px 0 rgba(0,0,0,.1),0 2px 15px 0 rgba(0,0,0,.05);display:flex;justify-content:space-between;max-height:800px;overflow:hidden;font-family:sans-serif;cursor:pointer;direction:ltr}.toast--rtl{direction:rtl}.toast--default{background:#fff;color:#aaa}.toast--info{background:#3498db}.toast--success{background:#07bc0c}.toast--warning{background:#f1c40f}.toast--error{background:#e74c3c}.toast-body{margin:auto 0;flex:1}@media only screen and (max-width:480px){.toast{margin-bottom:0}}.close-button{color:#fff;font-weight:700;font-size:14px;background:transparent;outline:none;border:none;padding:0;cursor:pointer;opacity:.7;transition:.3s ease;align-self:flex-start}.close-button--default{color:#000;opacity:.3}.close-button:focus,.close-button:hover{opacity:1}.progress-bar-cover{right:0;z-index:100;direction:rtl}.progress-bar,.progress-bar-cover{position:absolute;bottom:0;width:100%;height:5px;transform-origin:left}.progress-bar{left:0;z-index:99;opacity:.7;background-color:hsla(0,0%,100%,.7)}.progress-bar--controlled{transition:transform .2s}.progress-bar--rtl{right:0;left:auto;transform-origin:right}.progress-bar--default{background:linear-gradient(90deg,#4cd964,#5ac8fa,#007aff,#34aadc,#5856d6,#ff2d55)}.icon-container,.toast-body{vertical-align:middle}.icon-container{display:inline-block;width:25px}.icon-container span{margin-right:.5rem;display:inline-block;text-align:center;width:20px}.icon-container span i{vertical-align:middle}.fa,.material-icons{font-size:18px}.toast-container{display:inline-block;width:calc(100% - 25px);vertical-align:middle}"], directives: [{ type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i1.NgSwitch, selector: "[ngSwitch]", inputs: ["ngSwitch"] }, { type: i1.NgSwitchCase, selector: "[ngSwitchCase]", inputs: ["ngSwitchCase"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.5", ngImport: i0, type: ToastifyToastComponent, decorators: [{
            type: Component,
            args: [{
                    // tslint:disable-next-line:component-selector
                    selector: "lib-toastify-toast",
                    templateUrl: "./toastify-toast.component.html",
                    styleUrls: ["./toastify-toast.component.scss"],
                    // changeDetection: ChangeDetectionStrategy.OnPush
                }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }, { type: i0.NgZone }]; }, propDecorators: { progressBar: [{
                type: ViewChild,
                args: ["progressBar"]
            }], progressBarCover: [{
                type: ViewChild,
                args: ["progressBarCover"]
            }], autoClose: [{
                type: Input
            }], hideProgressBar: [{
                type: Input
            }], pauseOnHover: [{
                type: Input
            }], pauseOnVisibilityChange: [{
                type: Input
            }], closeOnClick: [{
                type: Input
            }], toast: [{
                type: Input
            }], iconLibrary: [{
                type: Input
            }], dismissEvent: [{
                type: Output
            }], handleHostClick: [{
                type: HostListener,
                args: ["click"]
            }], handleMouseEnter: [{
                type: HostListener,
                args: ["mouseenter"]
            }], handleMouseLeave: [{
                type: HostListener,
                args: ["mouseleave"]
            }], handleVisibilityChange: [{
                type: HostListener,
                args: ["document:visibilitychange"]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9hc3RpZnktdG9hc3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW5ndWxhci10b2FzdGlmeS9zcmMvbGliL3RvYXN0aWZ5LXRvYXN0L3RvYXN0aWZ5LXRvYXN0LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItdG9hc3RpZnkvc3JjL2xpYi90b2FzdGlmeS10b2FzdC90b2FzdGlmeS10b2FzdC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUdOLE1BQU0sRUFDTixTQUFTLEdBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDOzs7QUFXakMsTUFBTSxPQUFPLHNCQUFzQjtJQTJCakMsWUFBb0IsR0FBc0IsRUFBVSxLQUFhO1FBQTdDLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQXZCeEQsY0FBUyxHQUFHLElBQUksQ0FBQztRQUNqQixvQkFBZSxHQUFHLEtBQUssQ0FBQztRQUN4QixpQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQiw0QkFBdUIsR0FBRyxJQUFJLENBQUM7UUFDL0IsaUJBQVksR0FBRyxJQUFJLENBQUM7UUFJbkIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBWTVDLGNBQVMsR0FBRyxTQUFTLENBQUM7UUFDdEIsWUFBTyxHQUFHLEtBQUssQ0FBQztJQUVvRCxDQUFDO0lBRXJFLFFBQVE7UUFDTixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN6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dUJBQUMsa0JBQWtCO2dCQUVwQixTQUFTO3NCQUFqQixLQUFLO2dCQUNHLGVBQWU7c0JBQXZCLEtBQUs7Z0JBQ0csWUFBWTtzQkFBcEIsS0FBSztnQkFDRyx1QkFBdUI7c0JBQS9CLEtBQUs7Z0JBQ0csWUFBWTtzQkFBcEIsS0FBSztnQkFDRyxLQUFLO3NCQUFiLEtBQUs7Z0JBQ0csV0FBVztzQkFBbkIsS0FBSztnQkFFSSxZQUFZO3NCQUFyQixNQUFNO2dCQXFIUCxlQUFlO3NCQURkLFlBQVk7dUJBQUMsT0FBTztnQkFTckIsZ0JBQWdCO3NCQURmLFlBQVk7dUJBQUMsWUFBWTtnQkFRMUIsZ0JBQWdCO3NCQURmLFlBQVk7dUJBQUMsWUFBWTtnQkFTMUIsc0JBQXNCO3NCQURyQixZQUFZO3VCQUFDLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgVmlld0NoaWxkLFxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgVG9hc3RUeXBlIH0gZnJvbSBcIi4uL3RvYXN0LXR5cGVcIjtcbmltcG9ydCB7IFRvYXN0IH0gZnJvbSBcIi4uL3RvYXN0XCI7XG5pbXBvcnQgeyBpbnRlcnZhbCB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyB0aHJvdHRsZSwgdGhyb3R0bGVUaW1lIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5cbkBDb21wb25lbnQoe1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y29tcG9uZW50LXNlbGVjdG9yXG4gIHNlbGVjdG9yOiBcImxpYi10b2FzdGlmeS10b2FzdFwiLFxuICB0ZW1wbGF0ZVVybDogXCIuL3RvYXN0aWZ5LXRvYXN0LmNvbXBvbmVudC5odG1sXCIsXG4gIHN0eWxlVXJsczogW1wiLi90b2FzdGlmeS10b2FzdC5jb21wb25lbnQuc2Nzc1wiXSxcbiAgLy8gY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgVG9hc3RpZnlUb2FzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQFZpZXdDaGlsZChcInByb2dyZXNzQmFyXCIpIHByb2dyZXNzQmFyOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PjtcbiAgQFZpZXdDaGlsZChcInByb2dyZXNzQmFyQ292ZXJcIikgcHJvZ3Jlc3NCYXJDb3ZlcjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD47XG5cbiAgQElucHV0KCkgYXV0b0Nsb3NlID0gNTAwMDtcbiAgQElucHV0KCkgaGlkZVByb2dyZXNzQmFyID0gZmFsc2U7XG4gIEBJbnB1dCgpIHBhdXNlT25Ib3ZlciA9IHRydWU7XG4gIEBJbnB1dCgpIHBhdXNlT25WaXNpYmlsaXR5Q2hhbmdlID0gdHJ1ZTtcbiAgQElucHV0KCkgY2xvc2VPbkNsaWNrID0gdHJ1ZTtcbiAgQElucHV0KCkgdG9hc3Q6IFRvYXN0O1xuICBASW5wdXQoKSBpY29uTGlicmFyeTogXCJtYXRlcmlhbFwiIHwgXCJmb250LWF3ZXNvbWVcIiB8IFwibm9uZVwiO1xuXG4gIEBPdXRwdXQoKSBkaXNtaXNzRXZlbnQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcHJpdmF0ZSBleHBlY3RlZEF1dG9EaXNtaXNzVGltZTogbnVtYmVyO1xuICBwcml2YXRlIGF1dG9EaXNtaXNzVGltZW91dDogYW55O1xuICBwcml2YXRlIGF1dG9DbG9zZVJlbWFpbmluZzogbnVtYmVyO1xuXG4gIHByaXZhdGUgcGF1c2VUaW1lOiBudW1iZXI7XG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfcHJvZ3Jlc3NCYXJBbmltYXRpb246IG51bWJlcjtcbiAgcHJpdmF0ZSBfJHVwZGF0ZVRpbWVyO1xuXG4gIFRvYXN0VHlwZSA9IFRvYXN0VHlwZTtcbiAgcnVubmluZyA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NkOiBDaGFuZ2VEZXRlY3RvclJlZiwgcHJpdmF0ZSBfem9uZTogTmdab25lKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuYXV0b0Nsb3NlUmVtYWluaW5nID0gdGhpcy5hdXRvQ2xvc2U7XG4gICAgdGhpcy5zdGFydFRpbWUgPSB0aGlzLnRvYXN0LnRpbWU7XG4gICAgdGhpcy50b2FzdC4kcmVzZXRUb2FzdC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5yZXNldFRvYXN0VGltZXIoKSk7XG4gICAgLy8gRG8gbm90IHN0YXJ0IHRpbWVyIHdoZW4gdG9hc3QgaXMgcHJvbXB0ZWQgd2hpbGUgd2luZG93IGlzIG91dCBvZiBmb2N1c1xuICAgIGlmICh0aGlzLmhhbmRsZVZpc2liaWxpdHlDaGFuZ2UgJiYgZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSBcInZpc2libGVcIikge1xuICAgICAgdGhpcy5zdGFydENsb3NlVGltZXIoKTtcbiAgICB9XG5cbiAgICAvLyBTdGFydCBwcm9ncmVzcyBiYXIgYW5pbWF0aW9uXG4gICAgdGhpcy50cmlnZ2VyUHJvZ3Jlc3NCYXJBbmltYXRpb24oKTtcbiAgfVxuXG4gIHByaXZhdGUgdHJpZ2dlclByb2dyZXNzQmFyQW5pbWF0aW9uKCk6IHZvaWQge1xuICAgIC8vIENhbmNlbCBwcmV2aW91cyBhbmltbGF0aW9uIHRvIGF2b2lkIGxlYWtzXG4gICAgaWYgKHRoaXMuX3Byb2dyZXNzQmFyQW5pbWF0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX3Byb2dyZXNzQmFyQW5pbWF0aW9uKTtcbiAgICB9XG5cbiAgICAvLyBTdGFydCBhbmltYXRpb25cbiAgICBjb25zdCBmcmFtZSA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgY29uc3QgcmVtYWluaW5nVGltZSA9IE1hdGgubWF4KDAsIHRoaXMuZXhwZWN0ZWRBdXRvRGlzbWlzc1RpbWUgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSAxMDAgLSAoKHJlbWFpbmluZ1RpbWUgLyB0aGlzLmF1dG9DbG9zZSkgKiAxMDApO1xuICAgICAgICB0aGlzLnByb2dyZXNzQmFyQ292ZXIubmF0aXZlRWxlbWVudC5zdHlsZS53aWR0aCA9IHBlcmNlbnRhZ2UgKyBcIiVcIjtcbiAgICAgICAgaWYgKHBlcmNlbnRhZ2UgPD0gMCkgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5fcHJvZ3Jlc3NCYXJBbmltYXRpb24gPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnJhbWUpO1xuICAgIH07XG4gICAgdGhpcy5fcHJvZ3Jlc3NCYXJBbmltYXRpb24gPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnJhbWUpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgLy8gQ2FuY2VsIGFuaW1hdGlvblxuICAgIGlmICh0aGlzLl9wcm9ncmVzc0JhckFuaW1hdGlvbikge1xuICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fcHJvZ3Jlc3NCYXJBbmltYXRpb24pO1xuICAgICAgdGhpcy5fcHJvZ3Jlc3NCYXJBbmltYXRpb24gPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIC8vIENsZWFyIGF1dG8gY2xvc2UgdGltZW91dFxuICAgIHRoaXMuY2xlYXJUaW1lclRpbWVvdXQoKTtcbiAgICAvLyBDb21wbGV0ZSBhbGwgb2JzZXJ2YWJsZXNcbiAgICB0aGlzLnRvYXN0LiRyZXNldFRvYXN0Py5jb21wbGV0ZSgpO1xuICAgIHRoaXMudG9hc3QuJHJlc2V0VG9hc3QgPSBudWxsO1xuICAgIHRoaXMuXyR1cGRhdGVUaW1lcj8uY29tcGxldGUoKTtcbiAgICB0aGlzLl8kdXBkYXRlVGltZXIgPSBudWxsO1xuICB9XG5cbiAgc3RhcnRDbG9zZVRpbWVyKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnJ1bm5pbmcgfHwgIXRoaXMuYXV0b0Nsb3NlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcbiAgICB0aGlzLmV4cGVjdGVkQXV0b0Rpc21pc3NUaW1lID1cbiAgICAgIG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgdGhpcy5hdXRvQ2xvc2VSZW1haW5pbmc7XG4gICAgdGhpcy5hdXRvRGlzbWlzc1RpbWVvdXQgPSB0aGlzLl96b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5fem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZGlzbWlzc0V2ZW50LmVtaXQoKTtcbiAgICAgICAgICB0aGlzLl9jZC5tYXJrRm9yQ2hlY2soKTtcbiAgICAgICAgfSk7XG4gICAgICB9LCB0aGlzLmF1dG9DbG9zZVJlbWFpbmluZylcbiAgICApO1xuICB9XG5cbiAgcGF1c2VDbG9zZVRpbWVyKCk6IHZvaWQge1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgIHRoaXMuY2xlYXJUaW1lclRpbWVvdXQoKTtcblxuICAgIC8vIENhbGN1bGF0ZSB0aGUgZWxhcHNlZCB0aW1lLCBzdWJ0cmFjdCByZW1haW5pbmcgdGltZVxuICAgIHRoaXMucGF1c2VUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgZWxhcHNlZCA9IHRoaXMucGF1c2VUaW1lIC0gdGhpcy5zdGFydFRpbWU7XG4gICAgdGhpcy5hdXRvQ2xvc2VSZW1haW5pbmcgPSB0aGlzLmF1dG9DbG9zZSAtIGVsYXBzZWQ7XG4gIH1cblxuICByZXNldFRvYXN0VGltZXIoKSB7XG4gICAgdGhpcy5jbGVhclRpbWVyVGltZW91dCgpO1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuICAgIHRoaXMuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgdGhpcy5hdXRvQ2xvc2VSZW1haW5pbmcgPSB0aGlzLmF1dG9DbG9zZTtcbiAgICB0aGlzLnN0YXJ0Q2xvc2VUaW1lcigpO1xuICB9XG5cbiAgY2xlYXJUaW1lclRpbWVvdXQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuYXV0b0Rpc21pc3NUaW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuZXhwZWN0ZWRBdXRvRGlzbWlzc1RpbWUgPSB1bmRlZmluZWQ7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5hdXRvRGlzbWlzc1RpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZURpc21pc3NCdXR0b25BY3Rpb24oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY2xvc2VPbkNsaWNrKSB7XG4gICAgICByZXR1cm47IC8vIExldCB0aGUgb3RoZXIgZXZlbnQgaGFuZGxlIHRoZSBkaXNtaXNzYWxcbiAgICB9XG5cbiAgICB0aGlzLmNsZWFyVGltZXJUaW1lb3V0KCk7XG4gICAgdGhpcy5kaXNtaXNzRXZlbnQuZW1pdCgpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcihcImNsaWNrXCIpXG4gIGhhbmRsZUhvc3RDbGljaygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbG9zZU9uQ2xpY2spIHtcbiAgICAgIHRoaXMuY2xlYXJUaW1lclRpbWVvdXQoKTtcbiAgICAgIHRoaXMuZGlzbWlzc0V2ZW50LmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKFwibW91c2VlbnRlclwiKVxuICBoYW5kbGVNb3VzZUVudGVyKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnBhdXNlT25Ib3Zlcikge1xuICAgICAgdGhpcy5wYXVzZUNsb3NlVGltZXIoKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKFwibW91c2VsZWF2ZVwiKVxuICBoYW5kbGVNb3VzZUxlYXZlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnBhdXNlT25Ib3Zlcikge1xuICAgICAgdGhpcy5zdGFydENsb3NlVGltZXIoKTtcbiAgICAgIHRoaXMuc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAodGhpcy5zdGFydFRpbWUgLSB0aGlzLnBhdXNlVGltZSk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcihcImRvY3VtZW50OnZpc2liaWxpdHljaGFuZ2VcIilcbiAgaGFuZGxlVmlzaWJpbGl0eUNoYW5nZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucGF1c2VPblZpc2liaWxpdHlDaGFuZ2UpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlICE9PSBcInZpc2libGVcIikge1xuICAgICAgdGhpcy5wYXVzZUNsb3NlVGltZXIoKTtcbiAgICAgIHRoaXMuX2NkLmRldGVjdENoYW5nZXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGFydENsb3NlVGltZXIoKTtcbiAgICB9XG4gIH1cbn1cbiIsIjxkaXYgcm9sZT1cImFsZXJ0XCIgY2xhc3M9XCJ0b2FzdC1ib2R5XCI+XG4gICAgPGRpdiBjbGFzcz1cImljb24tY29udGFpbmVyXCI+XG4gICAgICAgIDxzcGFuICpuZ0lmPVwiaWNvbkxpYnJhcnkgPT0gJ21hdGVyaWFsJ1wiIFtuZ1N3aXRjaF09XCJ0b2FzdC50eXBlXCI+XG4gICAgICAgICAgICA8aSBjbGFzcz1cIm1hdGVyaWFsLWljb25zXCIgKm5nU3dpdGNoQ2FzZT1cIlRvYXN0VHlwZS5pbmZvXCI+aW5mb19vdXRsaW5lPC9pPlxuICAgICAgICAgICAgPGkgY2xhc3M9XCJtYXRlcmlhbC1pY29uc1wiICpuZ1N3aXRjaENhc2U9XCJUb2FzdFR5cGUuZGVmYXVsdFwiPmluZm9fb3V0bGluZTwvaT5cbiAgICAgICAgICAgIDxpIGNsYXNzPVwibWF0ZXJpYWwtaWNvbnNcIiAqbmdTd2l0Y2hDYXNlPVwiVG9hc3RUeXBlLndhcm5pbmdcIj53YXJuaW5nX291dGxpbmU8L2k+XG4gICAgICAgICAgICA8aSBjbGFzcz1cIm1hdGVyaWFsLWljb25zXCIgKm5nU3dpdGNoQ2FzZT1cIlRvYXN0VHlwZS5lcnJvclwiPmVycm9yX291dGxpbmU8L2k+XG4gICAgICAgICAgICA8aSBjbGFzcz1cIm1hdGVyaWFsLWljb25zXCIgKm5nU3dpdGNoQ2FzZT1cIlRvYXN0VHlwZS5zdWNjZXNzXCI+ZG9uZTwvaT5cbiAgICAgICAgPC9zcGFuPlxuICAgICAgICA8c3BhbiAqbmdJZj1cImljb25MaWJyYXJ5ID09ICdmb250LWF3ZXNvbWUnXCIgW25nU3dpdGNoXT1cInRvYXN0LnR5cGVcIj5cbiAgICAgICAgICAgIDxpICpuZ1N3aXRjaENhc2U9XCJUb2FzdFR5cGUuaW5mb1wiIGNsYXNzPVwiZmEgZmEtaW5mb1wiPjwvaT5cbiAgICAgICAgICAgIDxpICpuZ1N3aXRjaENhc2U9XCJUb2FzdFR5cGUuZGVmYXVsdFwiIGNsYXNzPVwiZmEgZmEtaW5mb1wiPjwvaT5cbiAgICAgICAgICAgIDxpICpuZ1N3aXRjaENhc2U9XCJUb2FzdFR5cGUud2FybmluZ1wiIGNsYXNzPVwiZmEgZmEtZXhjbGFtYXRpb24tdHJpYW5nbGVcIj48L2k+XG4gICAgICAgICAgICA8aSAqbmdTd2l0Y2hDYXNlPVwiVG9hc3RUeXBlLmVycm9yXCIgY2xhc3M9XCJmYSBmYS1leGNsYW1hdGlvblwiPjwvaT5cbiAgICAgICAgICAgIDxpICpuZ1N3aXRjaENhc2U9XCJUb2FzdFR5cGUuc3VjY2Vzc1wiIGNsYXNzPVwiZmEgZmEtY2hlY2tcIj48L2k+XG4gICAgICAgIDwvc3Bhbj5cbiAgICA8L2Rpdj5cbiAgICA8ZGl2IGNsYXNzPVwidG9hc3QtY29udGFpbmVyXCI+XG4gICAgICAgIDxzcGFuPnt7dG9hc3QubWVzc2FnZX19PC9zcGFuPlxuICAgIDwvZGl2PlxuPC9kaXY+XG48YnV0dG9uIChjbGljayk9XCJoYW5kbGVEaXNtaXNzQnV0dG9uQWN0aW9uKClcIiBjbGFzcz1cImNsb3NlLWJ1dHRvbiBjbG9zZS1idXR0b24tLXt7VG9hc3RUeXBlW3RvYXN0LnR5cGVdfX1cIiB0eXBlPVwiYnV0dG9uXCIgYXJpYS1sYWJlbD1cImNsb3NlXCI+4pyWPC9idXR0b24+XG5cbjxkaXYgI3Byb2dyZXNzQmFyICpuZ0lmPVwiIWhpZGVQcm9ncmVzc0JhclwiIGNsYXNzPVwicHJvZ3Jlc3MtYmFyIHByb2dyZXNzLWJhciYjNDU7JiM0NTt7e1RvYXN0VHlwZVt0b2FzdC50eXBlXX19XCIgc3R5bGU9XCJvcGFjaXR5OiAxO1wiPjwvZGl2PlxuPGRpdiAjcHJvZ3Jlc3NCYXJDb3ZlciAqbmdJZj1cIiFoaWRlUHJvZ3Jlc3NCYXJcIiBjbGFzcz1cInByb2dyZXNzLWJhci1jb3ZlciB0b2FzdC0te3tUb2FzdFR5cGVbdG9hc3QudHlwZV19fVwiIFtzdHlsZS5hbmltYXRpb24tZHVyYXRpb25dPVwidGhpcy5hdXRvQ2xvc2UgKyAnbXMnXCIgIFtzdHlsZS5hbmltYXRpb24tcGxheS1zdGF0ZV09XCJydW5uaW5nPyAncnVubmluZycgOiAncGF1c2VkJ1wiPjwvZGl2PlxuIl19